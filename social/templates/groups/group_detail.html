<!-- Needs refractoring, needs to be lesser than 300 lines. way too long. -->

{% extends 'landing/base.html' %}

{% block content %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'social/css/group/group_detail.css' %}">
{% endblock extra_css %}
     
    <!-- Group header -->
    <div class="container-fluid p-0">
        <div class="group-cover" data-banner-color="{{ group.banner_color|default:'#3498db' }}">
            <div class="cover-gradient"></div>
            <div class="container position-relative">
                <div class="group-header-content">
                    <a href="#" onclick="event.preventDefault(); history.back();" class="btn btn-outline-danger mb-3">
                        <i class="fas fa-arrow-left"></i> Back
                    </a>
                    <div class="group-title-container">
                        <h1 class="group-name">{{ group.name }}</h1>
                        {% if group.is_private %}
                        <span class="private-badge">
                            <i class="fas fa-lock me-1"></i>Private Group
                        </span>
                        {% else %}
                        <span class="public-badge">
                            <i class="fas fa-globe-americas me-1"></i>Public Group
                        </span>
                        {% endif %}
                    </div>
                    <div class="group-stats">
                        <div class="stat-item">
                            <i class="fas fa-users"></i>
                            <span>{{ group.members.count }} members</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-chart-line"></i>
                            <span>{{ posts.count }} posts</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container">
        <!-- Profile section -->
        <div class="profile-container">
            <div class="row g-0">
                <div class="col-md-auto">
                    {% if group.profile_image %}
                        <img src="{{ group.profile_image.url }}" alt="{{ group.name }}" class="rounded group-avatar">
                    {% else %}
                        <div class="rounded bg-primary d-flex align-items-center justify-content-center group-avatar">
                            <i class="fas fa-users fa-4x text-white"></i>
                        </div>
                    {% endif %}
                </div>
                <div class="col profile-content">
                    <p class="group-description">{{ group.description }}</p>
                    
                    <div class="action-buttons">
                        {% if group.is_private %}
                            {% if request.user in group.members.all %}
                                <div class="badge member-badge">
                                    <i class="fas fa-check-circle me-1"></i> Member
                                </div>
                            {% else %}
                                {% if pending_request %}
                                    <div class="badge pending-badge">
                                        <i class="fas fa-clock me-1"></i> Request Pending
                                    </div>
                                {% else %}
                                    <form method="POST" action="{% url 'join_group' group.id %}">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-join">
                                            <i class="fas fa-user-plus me-1"></i> Request to Join
                                        </button>
                                    </form>
                                {% endif %}
                            {% endif %}
                        {% else %}
                            {% if request.user not in group.members.all %}
                                <form method="POST" action="{% url 'join_group' group.id %}">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-join">
                                        <i class="fas fa-user-plus me-1"></i> Join Group
                                    </button>
                                </form>
                            {% else %}
                                <div class="badge member-badge">
                                    <i class="fas fa-check-circle me-1"></i> Member
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Group navigatiom -->
        <ul class="nav nav-custom mb-4">
            <li class="nav-item">
                <a class="nav-link active" href="#" id="posts-tab">
                    <i class="fas fa-newspaper me-1"></i> Posts
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" id="about-tab">
                    <i class="fas fa-info-circle me-1"></i> About
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" id="members-tab">
                    <i class="fas fa-users me-1"></i> Members
                </a>
            </li>
            {% if request.user == group.creator or request.user in group.admins.all %}
            <li class="nav-item ms-auto">
                <a class="nav-link admin-link" href="{% url 'admin_approval' group.id %}">
                    <i class="fas fa-cog me-1"></i> Manage Group
                </a>
            </li>
            {% endif %}
        </ul>
        
        <div class="row">
            <!-- Content area -->
            <div class="col-lg-8 order-lg-2">
                <div id="posts-section">
                <!-- Posts section -->
                    {% if posts %}
                        {% for post in posts %}
                            {% include "social/post_card.html" with post=post in_group=True %}
                        {% endfor %}
                    {% else %}
                        <div class="content-card empty-posts">
                            <i class="fas fa-newspaper"></i>
                            <h4 class="text-secondary">No posts yet</h4>
                            {% if request.user in group.members.all %}
                                <p class="text-muted">Be the first to share something with the group!</p>
                                <button class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#addPostModal">
                                    <i class="fas fa-plus me-1"></i> Create First Post
                                </button>
                            {% else %}
                                <p class="text-muted">Join the group to see and create posts.</p>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
                
                <!-- About -->
                <div id="about-section" class="d-none">
                    <div class="content-card">
                        <div class="card-title-bar">
                            <h5 class="card-title">About This Group</h5>
                        </div>
                        <div class="p-4">
                            <p class="about-description">{{ group.description }}</p>
                            
                            <div class="group-details mt-4">
                                <h6 class="section-title">Group Details</h6>
                                <div class="d-flex align-items-center mb-3">
                                    <div class="icon-circle">
                                        <i class="fas fa-calendar-alt text-primary"></i>
                                    </div>
                                    <span>Created on {{ group.created_at|date:"F j, Y" }}</span>
                                </div>
                                <div class="d-flex align-items-center mb-3">
                                    <div class="icon-circle">
                                        <i class="fas fa-users text-primary"></i>
                                    </div>
                                    <span>{{ group.members.count }} members</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <div class="icon-circle">
                                        <i class="fas fa-{% if group.is_private %}lock{% else %}globe-americas{% endif %} text-primary"></i>
                                    </div>
                                    <span>{{ group.is_private|yesno:"Private,Public" }} group</span>
                                </div>
                            </div>
                            
                            {% if rules %}
                            <div class="group-rules mt-4">
                                <h6 class="section-title">Group Rules</h6>
                                {% for rule in rules %}
                                <div class="group-rule">
                                    <h6 class="rule-title">{{ forloop.counter }}. {{ rule.title }}</h6>
                                    <p class="rule-description">{{ rule.description }}</p>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- count of total members section  -->
                <div id="members-section" class="d-none">
                    <div class="content-card">
                        <div class="card-title-bar">
                            <h5 class="card-title">Group Members ({{ group.members.count }})</h5>
                        </div>

                        <div class="p-3">
                            <!-- creator -->
                            <div class="group-member mb-3">
                                {% if group.creator.profile and group.creator.profile.picture %}
                                    <img src="{{ group.creator.profile.picture.url }}" class="rounded-circle member-img" alt="Creator">
                                {% else %}
                                    <div class="rounded-circle bg-secondary member-img d-flex align-items-center justify-content-center">
                                        <i class="fas fa-user text-light"></i>
                                    </div>
                                {% endif %}
                                <div class="member-info">
                                    {% if group.creator.profile %}
                                        <a href="{% url 'profile' group.creator.profile.pk %}" class="member-name">{{ group.creator }}</a>
                                    {% else %}
                                        <span class="member-name">{{ group.creator }}</span>
                                    {% endif %}
                                    <div class="badge creator-badge">Creator</div>
                                </div>
                            </div>
                            
                            <!-- Admins -->
                            {% if group.admins.all %}
                                <h6 class="section-title mt-4 mb-3">Admins</h6>
                                {% for admin in group.admins.all %}
                                <div class="group-member mb-3">
                                    {% if admin.profile.picture %}
                                        <img src="{{ admin.profile.picture.url }}" class="rounded-circle member-img" alt="Admin">
                                    {% else %}
                                        <div class="rounded-circle bg-secondary member-img d-flex align-items-center justify-content-center">
                                            <i class="fas fa-user text-light"></i>
                                        </div>
                                    {% endif %}
                                    <div class="member-info">
                                        <a href="{% url 'profile' admin.profile.pk %}" class="member-name">{{ admin }}</a>
                                        <div class="badge admin-badge">Admin</div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% endif %}
                            
                            <!-- Members list -->
                            <h6 class="section-title mt-4 mb-3">Members</h6>
                            {% for member in group.members.all %}
                                {% if member != group.creator and member not in group.admins.all %}
                                <div class="group-member mb-3">
                                    {% if member.profile.picture %}
                                        <img src="{{ member.profile.picture.url }}" class="rounded-circle member-img" alt="Member">
                                    {% else %}
                                        <div class="rounded-circle bg-secondary member-img d-flex align-items-center justify-content-center">
                                            <i class="fas fa-user text-light"></i>
                                        </div>
                                    {% endif %}
                                    <div class="member-info">
                                        <a href="{% url 'profile' member.profile.pk %}" class="member-name">{{ member }}</a>
                                    </div>
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- sidebar -->
            <div class="col-lg-4 order-lg-1">
                <div class="sticky" style="top: 100px;">
                    <!-- About -->
                    <div class="content-card sidebar-section mb-3">
                        <div class="card-title-bar">
                            <h5 class="card-title">About</h5>
                        </div>
                        <div class="p-3">
                            <p class="sidebar-description">{{ group.description }}</p>
                            <div class="d-flex align-items-center mb-3">
                                <div class="icon-circle-sm">
                                    <i class="fas fa-calendar-alt text-primary"></i>
                                </div>
                                <span>Created on {{ group.created_at|date:"F j, Y" }}</span>
                            </div>
                            <div class="d-flex align-items-center">
                                <div class="icon-circle-sm">
                                    <i class="fas fa-users text-primary"></i>
                                </div>
                                <span>{{ group.members.count }} members</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Rules -->
                    {% if rules %}
                    <div class="content-card sidebar-section mb-3">
                        <div class="card-title-bar">
                            <h5 class="card-title"><i class="fas fa-gavel me-2"></i>Group Rules</h5>
                        </div>
                        <div class="rules-container">
                            {% for rule in rules %}
                            <div class="group-rule">
                                <h6 class="rule-title">{{ forloop.counter }}. {{ rule.title }}</h6>
                                <p class="rule-description-sm">{{ rule.description }}</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="content-card sidebar-section">
                        <div class="card-title-bar">
                            <h5 class="card-title">Group Members</h5>
                        </div>
                    
                        <!-- Creator -->
                        <div class="sidebar-members">
                            {% if group.creator and group.creator.profile %}
                                <a href="{% url 'profile' group.creator.profile.pk %}" class="group-member d-flex align-items-center mb-2">
                                    {% if group.creator.profile.picture %}
                                        <img src="{{ group.creator.profile.picture.url }}" class="rounded-circle sidebar-member-img" alt="Creator">
                                    {% else %}
                                        <div class="rounded-circle bg-secondary sidebar-member-img d-flex align-items-center justify-content-center">
                                            <i class="fas fa-user text-light"></i>
                                        </div>
                                    {% endif %}
                                    <span class="member-name">{{ group.creator }}</span>
                                    <span class="badge creator-badge-sm ms-auto">Creator</span>
                                </a>
                            {% else %}
                                <div class="group-member d-flex align-items-center mb-2">
                                    <div class="rounded-circle bg-secondary sidebar-member-img d-flex align-items-center justify-content-center">
                                        <i class="fas fa-user text-light"></i>
                                    </div>
                                    <span class="member-name">{{ group.creator|default:"Unknown" }}</span>
                                    <span class="badge creator-badge-sm ms-auto">Creator</span>
                                </div>
                            {% endif %}
                        
                            <!-- Admins -->
                            {% if group.admins.all %}
                                <div class="card-subtitle mt-3 mb-2">
                                    <h6 class="sidebar-subtitle">Admins</h6>
                                </div>
                                {% for admin in group.admins.all %}
                                    <a href="{% url 'profile' admin.profile.pk %}" class="group-member d-flex align-items-center mb-2">
                                        {% if admin.profile.picture %}
                                            <img src="{{ admin.profile.picture.url }}" class="rounded-circle sidebar-member-img" alt="Admin">
                                        {% else %}
                                            <div class="rounded-circle bg-secondary sidebar-member-img d-flex align-items-center justify-content-center">
                                                <i class="fas fa-user text-light"></i>
                                            </div>
                                        {% endif %}
                                        <span class="member-name">{{ admin.username }}</span>
                                        <span class="badge admin-badge-sm ms-auto">Admin</span>
                                    </a>
                                {% endfor %}
                            {% endif %}
                        </div>
                
                        {% if user in group.members.all %}
                            <div class="p-3 border-top">
                                <form action="{% url 'leave_group' group.id %}" method="post" onsubmit="return confirm('Are you sure you want to leave this group?');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-leave-group">Leave Group</button>
                                </form>
                            </div>
                        {% endif %}
                    
                        <!-- Moderators -->
                        {% if moderators %}
                        <div class="content-card sidebar-section mt-3">
                            <div class="card-title-bar">
                                <h5 class="card-title">Moderators</h5>
                            </div>
                            <div class="sidebar-members">
                                {% for moderator in moderators %}
                                <a href="{% url 'profile' moderator.profile.pk %}" class="group-member d-flex align-items-center mb-2">
                                    {% if moderator.profile.picture %}
                                        <img src="{{ moderator.profile.picture.url }}" class="rounded-circle sidebar-member-img" alt="Moderator">
                                    {% else %}
                                        <div class="rounded-circle bg-secondary sidebar-member-img d-flex align-items-center justify-content-center">
                                            <i class="fas fa-user text-light"></i>
                                        </div>
                                    {% endif %}
                                    <span class="member-name">{{ moderator }}</span>
                                    <span class="badge moderator-badge ms-auto">Moderator</span>
                                </a>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    
                        {% if request.user == group.creator or request.user in group.admins.all %}
                            <div class="p-3 border-top">
                                <a href="{% url 'admin_approval' group.id %}" class="btn btn-admin">
                                    <i class="fas fa-user-check me-1"></i> Manage Join Requests
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>     
            </div>
        </div>
    </div>

    <!-- Post modal -->
    <div class="modal fade" id="addPostModal" tabindex="-1" aria-labelledby="addPostModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addPostModalLabel">Share with the Group</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="POST" enctype="multipart/form-data" id="postForm">
                        {% csrf_token %}
                        <div class="post-author-info mb-3">
                            <div class="d-flex align-items-center">
                                {% if request.user.profile.picture %}
                                    <img src="{{ request.user.profile.picture.url }}" class="rounded-circle post-author-img" width="48" height="48">
                                {% else %}
                                    <div class="rounded-circle bg-secondary post-author-img d-flex align-items-center justify-content-center">
                                        <i class="fas fa-user text-light"></i>
                                    </div>
                                {% endif %}
                                <div class="ms-2">
                                    <div class="post-author-name">{{ request.user }}</div>
                                    <div class="posting-to">
                                        <i class="fas fa-users me-1"></i> {{ group.name }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <textarea name="body" class="form-control post-textarea" id="id_body" rows="5" placeholder="What would you like to share?"></textarea>
                        </div>

                        <div id="imagePreviewContainer" class="mb-3 d-none">
                            <h6 class="image-preview-title">Image Preview</h6>
                            <div class="row g-2" id="previewImagesWrapper"></div>
                        </div>

                        <div class="post-options mb-3">
                            <div class="post-options-header">
                                <h6>Add to your post</h6>
                            </div>
                            <div class="post-options-buttons">
                                <label for="id_images" class="post-option-button">
                                    <i class="fas fa-image text-success"></i>
                                    <span>Photo</span>
                                </label>
                                <input type="file" name="images" class="d-none" id="id_images" accept="image/*" multiple>
                            </div>
                        </div>

                        <div class="d-grid">
                            <button type="submit" name="create_post" class="btn btn-post">
                                <i class="fas fa-paper-plane me-2"></i> Share Post
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% block extra_js %}
    <script src="{% static 'social/js/group/group_detail.js' %}"></script>
    {% endblock extra_js %}
{% endblock %}
        